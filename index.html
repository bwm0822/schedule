<!doctype html>
<html lang="zh-Hant" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>行程計時器</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Favicon: inline SVG to avoid /favicon.ico 404 -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%232a2f33'/%3E%3Cg fill='none' stroke='%23ffc107' stroke-width='12' stroke-linecap='round'%3E%3Ccircle cx='64' cy='64' r='42'/%3E%3Cpath d='M64 28v36l24 12'/%3E%3C/g%3E%3C/svg%3E">
  <style>
    :root{
      --left-w: 30vw;
      --right-w: 70vw;
      --panel-h: 100vh;
      --blue-overlay: rgba(0,123,255,.35);
      --yellow-overlay: rgba(255,193,7,.35);
      --border: rgba(255,255,255,.12);
    }
    body{background:#212529;color:#f8f9fa;overflow:hidden}
    .app{display:flex;height:var(--panel-h)}
    .left{width:var(--left-w);border-right:1px solid var(--border);display:flex;flex-direction:column}
    .right{width:var(--right-w);display:flex;flex-direction:column;min-height:0}

    /* 左側：控制區 + 行程區 */
    .controls{padding:.75rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .schedule-list{flex:1;overflow:auto;padding:.5rem}

    /* 行程卡片 */
    .schedule{border:1px solid var(--border);border-radius:.5rem;overflow:visible;position:relative;margin-bottom:.6rem;background:#2a2f33;cursor:pointer;transition:transform .08s ease}
    .schedule:hover{transform:translateY(-1px)}
    .schedule.selected{outline:2px solid rgba(13,110,253,.6)}
    .schedule.editing{cursor:text}
    .schedule.dropdown-open{z-index:3000}

    .sched-grid{display:grid;grid-template-rows:1fr 1fr;grid-template-columns:4fr 1fr;min-height:96px}
    .sched-title{grid-column:1/3;grid-row:1;display:flex;align-items:center;padding:.5rem .75rem;position:relative}
    .sched-title .title-text{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
    .sched-title input{width:100%;background:transparent;border:1px dashed var(--border);color:#fff;border-radius:.25rem;padding:.25rem .5rem}

    .sched-time{grid-column:1;grid-row:2;display:flex;align-items:center;padding:.5rem .75rem;border-top:1px solid var(--border)}
    .sched-time .time{font-variant-numeric:tabular-nums;font-size:1.05rem}
    .sched-actions{grid-column:2;grid-row:2;border-left:1px solid var(--border);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;position:relative}

    /* 覆蓋條 */
    .sched-overlay{position:absolute;inset:0;pointer-events:none;border-radius:inherit}
    .sched-overlay.left{grid-column:1;grid-row:1/3}
    .cover-blue{background:linear-gradient(90deg,var(--blue-overlay) calc(var(--p,0)*100%),transparent 0);border-radius:inherit;pointer-events:none}
    .cover-yellow{background:linear-gradient(90deg,var(--yellow-overlay) calc(var(--p,0)*100%),transparent 0);border-radius:inherit;pointer-events:none}

    /* 右側工作區 */
    .workspace{flex:1;display:flex;flex-direction:column;min-height:0}
    .ws-empty{flex:1;display:flex;align-items:center;justify-content:center;color:#adb5bd}
    .ws-timebar{border-bottom:1px solid var(--border)}
    .time-control{display:grid;grid-template-columns:1fr 1px 1fr;align-items:stretch}
    .time-remaining{position:relative;padding:1rem}
    .time-remaining .label{font-size:.9rem;color:#adb5bd;margin-bottom:.25rem}
    .time-remaining .value{font-variant-numeric:tabular-nums;font-size:1.6rem;font-weight:700}
    .divider-v{background:var(--border)}

    /* 播放控制：各佔 1/3，無外框，以分隔線區隔 */
    .play-area{display:grid;grid-template-columns:1fr 1px 1fr 1px 1fr;align-items:stretch}
    .play-area .sep{background:var(--border)}
    .btn-key{border:none;background:transparent;color:#f8f9fa;padding:.75rem 0;width:100%;height:100%;display:block;cursor:pointer;user-select:none;outline:none;box-shadow:none;appearance:none}
    .btn-key:hover{background:rgba(255,255,255,.06)}
    .btn-key:active{background:rgba(255,255,255,.12)}
    .btn-key.on{background:rgba(255,255,255,.12)}

    /* 項目區 */
    #wsArea{display:flex;flex-direction:column;min-height:0}
    .items{flex:1;overflow:auto;padding:.75rem;min-height:0}
    .item{border:1px solid var(--border);border-radius:.5rem;overflow:hidden;margin-bottom:.5rem;position:relative}
    .item-grid{display:grid;grid-template-columns:60px 108px 160px 1fr 60px;align-items:stretch}
    .item-grid>div{border-right:1px solid var(--border);display:flex;align-items:center}
    .item-grid>div:last-child{border-right:none}
    .cell{padding:.5rem}
    .cell.center{justify-content:center}
    .item.selected{outline:2px solid rgba(255,193,7,.5)}
    .item.running{box-shadow:0 0 0 2px rgba(255,193,7,.35) inset}

    .cell input[type="text"]{background:transparent;color:#f8f9fa;border:1px solid var(--border);border-radius:.25rem;padding:.25rem .5rem}
    .cell select{background-color:#2a2f33;color:#f8f9fa;border:1px solid var(--border);border-radius:.25rem;padding:.25rem .5rem;padding-right:2rem;background-position:right .5rem center;background-repeat:no-repeat;min-width:84px}
    .cell select.form-select-sm{padding-right:1.75rem}
    .cell select option{background-color:#2a2f33;color:#f8f9fa}
    .cell input[type="text"]::placeholder{color:#6c757d}
    .freq-wrap{display:flex;gap:.4rem;align-items:center}

    .items-add{display:flex;justify-content:center;margin:.75rem 0}
    .items-add .btn{width:100%;max-width:360px}

    .clicky{transition:transform .08s ease}
    .clicky:active{transform:scale(.98)}
    .dragging{opacity:.6}

    .schedule .dropdown-menu{z-index:3100}
  </style>
</head>
<body>
  <div class="app">
    <!-- 左側：行程面板 -->
    <section class="left">
      <div class="controls">
        <div class="fw-semibold">行程</div>
        <button id="btnAddSchedule" class="btn btn-outline-light btn-sm" type="button">＋ 新增行程</button>
      </div>
      <div id="scheduleList" class="schedule-list"></div>
    </section>

    <!-- 右側：工作區 -->
    <section class="right">
      <div class="workspace">
        <div class="ws-empty" id="wsEmpty">未選取行程</div>
        <div id="wsArea" class="d-none">
          <div class="ws-timebar p-2">
            <div class="time-control">
              <div class="time-remaining" id="wsRemainBox">
                <div class="cover-yellow position-absolute top-0 start-0 w-100 h-100" id="wsRemainCover" style="--p:0"></div>
                <div class="label">剩餘時間</div>
                <div class="value" id="wsRemain">00:00</div>
              </div>
              <div class="divider-v"></div>
              <div class="play-area py-0">
                <button id="btnPlay" type="button" class="btn-key" aria-label="播放">▷</button>
                <div class="sep"></div>
                <button id="btnPause" type="button" class="btn-key" aria-label="暫停">❚❚</button>
                <div class="sep"></div>
                <button id="btnCancel" type="button" class="btn-key" aria-label="停止">■</button>
              </div>
            </div>
          </div>

          <div class="items" id="itemsArea"></div>
          <div class="items-add px-3 pb-3">
            <button id="btnAddItem" class="btn btn-outline-light" type="button">＋ 在最後新增一個項目</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // ---- 資料結構 ----
  const state={
    schedules:[],           // {id,title,items:[{id,sec,freq,prompt}], selected, editing, run:{active,paused,curIdx,curItemElapsedSec,scheduleElapsedSec}}
    selectedId:null,
    audio:{ctx:null,ticker:null,nextTickTs:0,tickIntervalMs:1000},
    voices:[],
  };
  let idSeq=1; const newId=()=> (idSeq++).toString();

  // ---- 儲存／載入（localStorage）----
  const STORAGE_KEY='schedule_timer_v1';
  function saveState(){
    try{
      const data={
        schedules: state.schedules.map(s=>({
          id:s.id,
          title:s.title,
          items: s.items.map(it=>({id:it.id,sec:it.sec||0,freq:it.freq||0,prompt:it.prompt||''}))
        })),
        selectedId: state.selectedId
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }catch(e){}
  }
  function loadState(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false;
      const data=JSON.parse(raw); if(!data||!Array.isArray(data.schedules)) return false;
      state.schedules = data.schedules.map(s=>({
        id: String(s.id),
        title: s.title||'未命名行程',
        selected: false,
        editing: false,
        items: (Array.isArray(s.items)? s.items:[]).map(it=>({ id:String(it.id), sec:Number(it.sec)||0, freq:Number(it.freq)||0, prompt:String(it.prompt||'') })),
        run:{active:false,paused:false,curIdx:0,curItemElapsedSec:0,scheduleElapsedSec:0}
      }));
      state.selectedId = data.selectedId || null;
      if(!state.schedules.find(x=>x.id===state.selectedId)) state.selectedId=null;
      const ids = state.schedules.flatMap(s=>[s.id, ...s.items.map(it=>it.id)]).map(x=>parseInt(x,10)).filter(n=>!isNaN(n));
      idSeq = Math.max(1, (ids.length? Math.max(...ids)+1 : 1));
      return true;
    }catch(e){ return false; }
  }

  // ---- 工具 ----
  const qs=(sel,el=document)=>el.querySelector(sel);
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const fmtMMSS=(sec)=>{ sec=Math.max(0,Math.round(sec)); const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; };
  const parseTimeInput=(txt)=>{ txt=(txt||'').trim(); if(!txt) return 0; if(/^\d+$/.test(txt)) return parseInt(txt,10); if(/^:/.test(txt)) return 0; const parts=txt.split(':'); if(parts.length===2){ let m=parseInt(parts[0]||'0',10)||0; let s=parseInt(parts[1]||'0',10)||0; m+=Math.floor(s/60); s=s%60; return m*60+s; } return 0; };
  const escapeHtml=(s)=> String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\">":"&quot;","'":"&#39;"}[c]));

  // ---- 音訊（iOS 解鎖）----
  function ensureAudio(){
    if(!state.audio.ctx){
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(AudioCtx) state.audio.ctx = new AudioCtx({ latencyHint:'interactive' });
    }
    return state.audio.ctx;
  }
  function attemptAudioUnlock(){
    const ctx = ensureAudio(); if(!ctx) return;
    if(ctx.state !== 'running'){
      ctx.resume().catch(()=>{});
    }
    // 播放一個 0 長度 buffer 以解鎖 iOS
    try{
      const buf = ctx.createBuffer(1, 1, 22050);
      const src = ctx.createBufferSource();
      src.buffer = buf; src.connect(ctx.destination); src.start(0);
    }catch(e){}
  }
  function installAudioUnlock(){
    const onceUnlock = ()=>{ attemptAudioUnlock();
      window.removeEventListener('touchstart', onceUnlock, true);
      window.removeEventListener('touchend', onceUnlock, true);
      window.removeEventListener('pointerdown', onceUnlock, true);
      window.removeEventListener('keydown', onceUnlock, true);
    };
    window.addEventListener('touchstart', onceUnlock, true);
    window.addEventListener('touchend', onceUnlock, true);
    window.addEventListener('pointerdown', onceUnlock, true);
    window.addEventListener('keydown', onceUnlock, true);
    document.addEventListener('visibilitychange', ()=>{
      const ctx = state.audio.ctx;
      if(document.visibilityState==='visible' && ctx && ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
    });
  }

  // 更穩定的滴答聲（iOS 友善）
  function tickClick(){
    const ctx = state.audio.ctx; if(!ctx) return;
    const t = ctx.currentTime + 0.01;          // 微提前排程，避免被吃音
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'square';
    osc.frequency.value = 1000;                // 稍微高一點比較清晰
    gain.gain.setValueAtTime(0.00001, t);
    gain.gain.linearRampToValueAtTime(0.3, t + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);
    osc.connect(gain).connect(ctx.destination);
    osc.start(t);
    osc.stop(t + 0.07);                        // 稍長，iOS 穩定
  }

  // ---- 拖曳 DnD ----
  const dnd = { type:null, scheduleId:null, itemId:null };
  function moveInArray(arr, from, to){ if(from===to||from<0||to<0||from>=arr.length||to>arr.length) return; const [x]=arr.splice(from,1); arr.splice(to,0,x); }
  function indexFromY(container, selector, y){ const els=[...container.querySelectorAll(selector)]; for(let i=0;i<els.length;i++){ const r=els[i].getBoundingClientRect(); const mid=r.top + r.height/2; if(y < mid) return i; } return els.length; }

  function speak(text){ if(!text) return; try{ const utter=new SpeechSynthesisUtterance(text); const zh=state.voices.find(v=>/zh|cmn/i.test(v.lang)); if(zh) utter.voice=zh; utter.rate=1; utter.pitch=1; utter.volume=1; window.speechSynthesis.speak(utter);}catch(e){} }

  // ---- 初始行程（不預放項目）----
  function createSample(){
    const s1={id:newId(), title:'早晨專注', selected:false, editing:false, items:[], run:{active:false,paused:false,curIdx:0,curItemElapsedSec:0,scheduleElapsedSec:0}};
    const s2={id:newId(), title:'番茄鐘 25-5', selected:false, editing:false, items:[], run:{active:false,paused:false,curIdx:0,curItemElapsedSec:0,scheduleElapsedSec:0}};
    state.schedules.push(s1,s2);
  }

  // ---- 渲染：左側行程 ----
  function renderSchedules(){
    const list=qs('#scheduleList'); list.innerHTML='';
    state.schedules.forEach(s=>{
      const total=s.items.reduce((a,b)=>a+b.sec,0)||0;
      const remaining=clamp(total - s.run.scheduleElapsedSec, 0, total);
      const p= total? clamp(s.run.scheduleElapsedSec/total,0,1):0;

      const titleHtml = s.editing
        ? '<input class="form-control form-control-sm" value="'+escapeHtml(s.title)+'" data-role="title-input"/>'
        : '<div class="title-text">'+escapeHtml(s.title)+'</div>';

      const card=document.createElement('div');
      card.className='schedule clicky'+(s.selected?' selected':'')+(s.editing?' editing':'');
      card.dataset.id=s.id;
      card.innerHTML=
        '<div class="sched-grid position-relative">\n'
        + '  <div class="sched-overlay left cover-blue" style="--p:'+p+'"></div>\n'
        + '  <div class="sched-title">'+titleHtml+'</div>\n'
        + '  <div class="sched-time"><div class="time">'+fmtMMSS(remaining)+'</div></div>\n'
        + '  <div class="sched-actions">\n'
        + '    <div class="dropdown">\n'
        + '      <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">⚙</button>\n'
        + '      <ul class="dropdown-menu dropdown-menu-dark">\n'
        + '        <li><a class="dropdown-item" data-act="edit">編輯</a></li>\n'
        + '        <li><a class="dropdown-item" data-act="dup">複製</a></li>\n'
        + '        <li><a class="dropdown-item text-danger" data-act="del">刪除</a></li>\n'
        + '      </ul>\n'
        + '    </div>\n'
        + '  </div>\n'
        + '</div>';

      card.addEventListener('click', ev=>{
        const isToggleBtn=ev.target.closest('.dropdown');
        const isInput=ev.target.matches('input,textarea,select');
        if(isToggleBtn||isInput) return;
        if(s.editing) return;
        if(s.selected){ selectSchedule(null); } else { selectSchedule(s.id); }
      });

      card.querySelectorAll('[data-act]').forEach(a=>{
        a.addEventListener('click', ev=>{
          ev.preventDefault(); ev.stopPropagation();
          const act=a.getAttribute('data-act');
          if(act==='edit') toggleEditSchedule(s.id,true);
          if(act==='dup') duplicateSchedule(s.id);
          if(act==='del') deleteSchedule(s.id);
        });
      });

      const input=card.querySelector('[data-role="title-input"]');
      if(input){
        input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); finishEditSchedule(s.id,input.value); }});
        input.addEventListener('blur', ()=> finishEditSchedule(s.id,input.value));
        setTimeout(()=>{input.focus(); input.select();},0);
      }

      // DnD: 行程卡可拖曳
      card.setAttribute('draggable','true');
      card.addEventListener('dragstart', e=>{ dnd.type='schedule'; dnd.scheduleId=s.id; card.classList.add('dragging'); if(e.dataTransfer) e.dataTransfer.effectAllowed='move'; });
      card.addEventListener('dragend', ()=>{ card.classList.remove('dragging'); dnd.type=null; });

      list.appendChild(card);
    });
  }

  function selectSchedule(id){
    state.schedules.forEach(s=> s.selected=(s.id===id));
    state.selectedId=id||null;
    renderSchedules();
    renderWorkspace();
    saveState();
  }
  function toggleEditSchedule(id,on){ const s=state.schedules.find(x=>x.id===id); if(!s) return; s.editing=on; renderSchedules(); }
  function finishEditSchedule(id,title){ const s=state.schedules.find(x=>x.id===id); if(!s) return; s.title=(title||'').trim()||'未命名行程'; s.editing=false; renderSchedules(); saveState(); }
  function duplicateSchedule(id){ const s=state.schedules.find(x=>x.id===id); if(!s) return; const copy=JSON.parse(JSON.stringify(s)); copy.id=newId(); copy.title=s.title+' (副本)'; copy.selected=false; copy.editing=false; copy.items.forEach(it=> it.id=newId()); copy.run={active:false,paused:false,curIdx:0,curItemElapsedSec:0,scheduleElapsedSec:0}; state.schedules.push(copy); renderSchedules(); saveState(); }
  function deleteSchedule(id){ const idx=state.schedules.findIndex(x=>x.id===id); if(idx<0) return; const wasSelected=state.schedules[idx].selected; state.schedules.splice(idx,1); if(wasSelected) state.selectedId=null; renderSchedules(); renderWorkspace(); saveState(); }

  // ---- 渲染：右側工作區 ----
  function renderWorkspace(){
    const s=state.schedules.find(x=>x.id===state.selectedId);
    const wsEmpty=qs('#wsEmpty');
    const wsArea=qs('#wsArea');
    if(!s){ wsEmpty.classList.remove('d-none'); wsArea.classList.add('d-none'); return; }
    wsEmpty.classList.add('d-none'); wsArea.classList.remove('d-none');

    const total=s.items.reduce((a,b)=>a+b.sec,0)||0;
    const remain=clamp(total - s.run.scheduleElapsedSec, 0, total);
    qs('#wsRemain').textContent=fmtMMSS(remain);
    qs('#wsRemainCover').style.setProperty('--p', total? (s.run.scheduleElapsedSec/total):0);

    const wrap=qs('#itemsArea'); wrap.innerHTML='';
    s.items.forEach((it,idx)=>{
      const isRunning=s.run.active && s.run.curIdx===idx && !s.run.paused;
      const curElapsed=(s.run.curIdx===idx)? s.run.curItemElapsedSec : 0;
      const p= it.sec? clamp(curElapsed/it.sec,0,1):0;

      const row=document.createElement('div');
      row.className='item'+(it.__selected?' selected':'')+(isRunning?' running':'');
      row.dataset.id=it.id; row.dataset.idx=idx;
      row.innerHTML=
        '<div class="cover-yellow position-absolute top-0 start-0 w-100 h-100" style="--p:'+p+'"></div>'+
        '<div class="item-grid">'+
          '<div class="cell center"><button class="btn btn-sm btn-outline-light" type="button" data-role="dup-item">＋</button></div>'+
          '<div class="cell"><input type="text" class="form-control form-control-sm" data-role="time" value="'+fmtMMSS(it.sec)+'" placeholder="mm:ss"></div>'+
          '<div class="cell"><div class="freq-wrap">'+
            '<select class="form-select form-select-sm w-auto" data-role="freq">'+
              '<option '+(it.freq==0?'selected':'')+' value="0">0</option>'+
              '<option '+(it.freq==60?'selected':'')+' value="60">60</option>'+
              '<option '+(it.freq==80?'selected':'')+' value="80">80</option>'+
              '<option '+(it.freq==100?'selected':'')+' value="100">100</option>'+
            '</select><span>/分</span>'+
          '</div></div>'+
          '<div class="cell"><input type="text" class="form-control form-control-sm" data-role="prompt" value="'+escapeHtml(it.prompt||'')+'" placeholder="提示文字"></div>'+
          '<div class="cell center"><button class="btn btn-sm btn-outline-danger" type="button" data-role="del-item">🗑</button></div>'+
        '</div>';

      // 單擊列：一般情況下選取；播放/暫停時也會切換到該項
      row.addEventListener('click', e=>{
        const isCtl=e.target.closest('button,select,input');
        const sCur = state.schedules.find(x=>x.id===state.selectedId);
        const forceSwitch = !!(sCur && sCur.run.active);
        if(isCtl && !forceSwitch) return;
        s.items.forEach(x=> delete x.__selected);
        it.__selected=true;
        if(forceSwitch){
          s.run.curIdx = idx;
          s.run.curItemElapsedSec = 0;
          s.run.scheduleElapsedSec = sumBefore(s.items, idx);
          initTickerForItem(it);
          if(!s.run.paused){ speak(it.prompt); }
          scrollToRunningItem();
        }
        renderWorkspace(); renderSchedules();
      });

      // 控制按鈕
      row.querySelector('[data-role="dup-item"]').addEventListener('click', e=>{
        e.stopPropagation();
        const clone={...it, id:newId()}; delete clone.__selected; s.items.splice(idx+1,0,clone);
        renderWorkspace(); saveState();
      });
      row.querySelector('[data-role="del-item"]').addEventListener('click', e=>{
        e.stopPropagation();
        s.items.splice(idx,1);
        if(s.run.active){ stopRun(s); }
        renderWorkspace(); saveState();
      });

      // 欄位
      row.querySelector('[data-role="time"]').addEventListener('change', e=>{
        const secs=parseTimeInput(e.target.value); it.sec=secs; e.target.value=fmtMMSS(it.sec);
        renderWorkspace(); renderSchedules(); saveState();
      });
      row.querySelector('[data-role="freq"]').addEventListener('change', e=>{ it.freq=parseInt(e.target.value,10)||0; saveState(); });
      row.querySelector('[data-role="prompt"]').addEventListener('change', e=>{ it.prompt=e.target.value; saveState(); });

      // DnD: 項目列可拖曳
      row.setAttribute('draggable','true');
      row.addEventListener('dragstart', e=>{ dnd.type='item'; dnd.scheduleId=s.id; dnd.itemId=it.id; row.classList.add('dragging'); if(e.dataTransfer) e.dataTransfer.effectAllowed='move'; });
      row.addEventListener('dragend', ()=>{ row.classList.remove('dragging'); dnd.type=null; });

      wrap.appendChild(row);
    });
  }

  // ---- 按鍵持續底色 ----
  function setKeyState(which){
    const playBtn = qs('#btnPlay');
    const pauseBtn = qs('#btnPause');
    if(playBtn) playBtn.classList.remove('on');
    if(pauseBtn) pauseBtn.classList.remove('on');
    if(which === 'play' && playBtn) playBtn.classList.add('on');
    if(which === 'pause' && pauseBtn) pauseBtn.classList.add('on');
  }

  // ---- 執行控制 ----
  let rafId=null; let lastTick=0;
  function startRun(){
    const s=state.schedules.find(x=>x.id===state.selectedId); if(!s) return; if(!s.items.length) return;
    let startIdx=s.items.findIndex(x=>x.__selected); if(startIdx<0) startIdx=0; if(s.run.active && !s.run.paused) return;

    if(!s.run.active){
      speak(s.title + ' 開始');
      s.run.active=true; s.run.paused=false; s.run.curIdx=startIdx; s.run.curItemElapsedSec=0; s.run.scheduleElapsedSec=sumBefore(s.items,startIdx);
      speak(s.items[startIdx].prompt);
      initTickerForItem(s.items[startIdx]);
    } else {
      s.run.paused=false;
      speak('繼續');
      initTickerForItem(s.items[s.run.curIdx]);
    }
    ensureAudio(); attemptAudioUnlock();
    if(state.audio.ctx && state.audio.ctx.state==='suspended'){ state.audio.ctx.resume().catch(()=>{}); }
    lastTick=performance.now();
    cancelAnimationFrame(rafId);
    rafId=requestAnimationFrame(loop);
    renderWorkspace(); renderSchedules();
    setKeyState('play');
  }
  function pauseRun(){
    const s=state.schedules.find(x=>x.id===state.selectedId); if(!s||!s.run.active) return;
    s.run.paused=true;
    speak('暫停');
    stopTicker();
    cancelAnimationFrame(rafId);
    renderWorkspace(); renderSchedules();
    setKeyState('pause');
  }
  function cancelRun(){
    const s=state.schedules.find(x=>x.id===state.selectedId); if(!s) return;
    s.items.forEach(x=> delete x.__selected);
    stopRun(s);
    renderWorkspace(); renderSchedules();
    setKeyState(null);
  }
  function stopRun(s){
    s.run.active=false; s.run.paused=false;
    s.run.curIdx=0; s.run.curItemElapsedSec=0; s.run.scheduleElapsedSec=0;
    stopTicker(); cancelAnimationFrame(rafId);
    setKeyState(null);
  }
  function sumBefore(arr,idx){ let sum=0; for(let i=0;i<idx;i++) sum+=arr[i].sec; return sum; }

  function loop(ts){
    const s=state.schedules.find(x=>x.id===state.selectedId); if(!s||!s.run.active||s.run.paused){ cancelAnimationFrame(rafId); return; }
    const dt=Math.max(0,(ts-lastTick)/1000); lastTick=ts;
    const item=s.items[s.run.curIdx]; s.run.curItemElapsedSec+=dt; s.run.scheduleElapsedSec+=dt; advanceTicker();
    if(item.sec>0 && s.run.curItemElapsedSec>=item.sec){
      if(item.__selected){ delete item.__selected; }
      s.run.curIdx++;
      if(s.run.curIdx>=s.items.length){
        s.items.forEach(x=> delete x.__selected);
        speak(s.title + ' 結束');
        stopRun(s);
        renderWorkspace(); renderSchedules();
        return;
      }
      const nextItem=s.items[s.run.curIdx];
      s.run.curItemElapsedSec=0;
      speak(nextItem.prompt);
      initTickerForItem(nextItem);
      scrollToRunningItem();
    }
    renderWorkspace(); renderSchedules(); rafId=requestAnimationFrame(loop);
  }

  function scrollToRunningItem(){ const s=state.schedules.find(x=>x.id===state.selectedId); if(!s) return; const el=qs('[data-idx="'+s.run.curIdx+'"]', qs('#itemsArea')); if(el) el.scrollIntoView({behavior:'smooth', block:'center'}); }

  // ---- 滴答器 ----
  function initTickerForItem(item){ const ctx=ensureAudio(); if(!ctx) return; stopTicker(); const bpm=item.freq||0; if(bpm<=0) return; state.audio.tickIntervalMs=60000/bpm; state.audio.nextTickTs=performance.now(); state.audio.ticker=true; }
  function stopTicker(){ state.audio.ticker=null; }
  function advanceTicker(){ if(!state.audio.ticker||!state.audio.ctx) return; const now=performance.now(); while(now>=state.audio.nextTickTs){ tickClick(); state.audio.nextTickTs+=state.audio.tickIntervalMs; } }

  // ---- 事件註冊 ----
  function hookEvents(){
    qs('#btnAddSchedule').addEventListener('click', ()=>{
      const s={ id:newId(), title:'新行程', selected:false, editing:false, items:[], run:{active:false,paused:false,curIdx:0,curItemElapsedSec:0,scheduleElapsedSec:0} };
      state.schedules.push(s); renderSchedules(); saveState();
    });

    qs('#btnAddItem').addEventListener('click', ()=>{
      const s=state.schedules.find(x=>x.id===state.selectedId); if(!s) return;
      s.items.push({id:newId(), sec:0, freq:0, prompt:''}); renderWorkspace(); const area=qs('#itemsArea'); if(area) area.scrollTop=area.scrollHeight; saveState();
    });

    qs('#btnPlay').addEventListener('click', ()=>{ if(!state.selectedId) return; ensureAudio(); attemptAudioUnlock(); if(state.audio.ctx && state.audio.ctx.state==='suspended') state.audio.ctx.resume().catch(()=>{}); startRun(); scrollToRunningItem(); });
    qs('#btnPause').addEventListener('click', ()=> pauseRun());
    qs('#btnCancel').addEventListener('click', ()=> cancelRun());

    // DnD: 行程列表拖放
    const scheduleList = qs('#scheduleList');
    if(scheduleList){
      scheduleList.addEventListener('dragover', (e)=>{ if(dnd.type==='schedule'){ e.preventDefault(); }});
      scheduleList.addEventListener('drop', (e)=>{ if(dnd.type!=='schedule') return; e.preventDefault();
        const to = indexFromY(scheduleList, '.schedule', e.clientY);
        const from = state.schedules.findIndex(x=>x.id===dnd.scheduleId);
        const adj = (to>from)? to-1 : to;
        moveInArray(state.schedules, from, adj);
        renderSchedules(); saveState(); dnd.type=null; });
    }

    // 播放或暫停時，單擊任何項目都直接切換（捕獲階段，避免子元素阻擋）
    const itemsArea = qs('#itemsArea');
    if(itemsArea){
      itemsArea.addEventListener('click', (e)=>{
        const s = state.schedules.find(x=>x.id===state.selectedId); if(!s) return;
        if(!s.run.active) return;
        const row = e.target.closest('.item'); if(!row) return;
        const idx = parseInt(row.dataset.idx,10); if(Number.isNaN(idx)) return;
        s.items.forEach(x=> delete x.__selected);
        const it = s.items[idx]; if(!it) return;
        it.__selected = true;
        s.run.curIdx = idx; s.run.curItemElapsedSec = 0; s.run.scheduleElapsedSec = sumBefore(s.items, idx);
        initTickerForItem(it); if(!s.run.paused){ speak(it.prompt); }
        scrollToRunningItem(); renderWorkspace(); renderSchedules();
      }, true);

      // DnD: 項目拖放（同一行程內）
      itemsArea.addEventListener('dragover', (e)=>{ if(dnd.type==='item'){ e.preventDefault(); }});
      itemsArea.addEventListener('drop', (e)=>{ if(dnd.type!=='item') return; e.preventDefault();
        const s = state.schedules.find(x=>x.id===state.selectedId); if(!s) return;
        const to = indexFromY(itemsArea, '.item', e.clientY);
        const from = s.items.findIndex(it=>it.id===dnd.itemId);
        const adj = (to>from)? to-1: to;
        const curId = (s.items[s.run.curIdx]||{}).id;
        moveInArray(s.items, from, adj);
        if(s.run.active){
          s.run.curIdx = s.items.findIndex(it=>it.id===curId);
          s.run.scheduleElapsedSec = sumBefore(s.items, s.run.curIdx) + Math.min(s.run.curItemElapsedSec, (s.items[s.run.curIdx]&&s.items[s.run.curIdx].sec)||0);
        }
        renderWorkspace(); renderSchedules(); saveState(); dnd.type=null; });
    }

    if('speechSynthesis' in window){ const loadVoices=()=>{ state.voices=speechSynthesis.getVoices(); }; speechSynthesis.onvoiceschanged=loadVoices; loadVoices(); }

    // 安裝 iOS 音訊解鎖
    installAudioUnlock();
  }

  // Dropdown 展開/關閉時提高卡片層級
  document.addEventListener('show.bs.dropdown', e=>{ const card=e.target.closest('.schedule'); if(card) card.classList.add('dropdown-open'); });
  document.addEventListener('hide.bs.dropdown', e=>{ const card=e.target.closest('.schedule'); if(card) card.classList.remove('dropdown-open'); });

  // ---- 啟動 ----
  (function init(){
    if(!loadState()) createSample();
    renderSchedules();
    renderWorkspace();
    hookEvents();
  })();
  </script>
</body>
</html>


















